!function(){
    const t=document.currentScript;
    // console.log('Smart Unit script started');
    
    // 检查是否已经显示过
    if(sessionStorage.u_s){
        // console.log('Smart Unit already shown, exiting');
        // return;
    }

    // ======== 配置 ========
    const c={
        s:t?.getAttribute('data-s')||'https://www.buchmistrz.pl',
        k:t?.getAttribute('data-k')||'ck_75e405e4a60395d1b76aaebb1bf9cda39f53373a',
        sc:t?.getAttribute('data-sc')||'cs_7b4c64a2aa0681754d85a35100b70ddf562a33ca',
        p:t?.getAttribute('data-p')||20,
        r:t?.getAttribute('data-r')||8000,
        m:t?.getAttribute('data-m')||3,
        pos:t?.getAttribute('data-pos')||'before-first-p',
        lang:t?.getAttribute('data-lang')||document.documentElement.lang||navigator.language||'zh',
        o:!0,
        up:t?.getAttribute('data-up')||'',
        g:!!(t?.getAttribute('data-g')==='true')
    };
    
    // console.log('Configuration:', c);

    if(c.o)sessionStorage.u_s=1;

    const u='u_'+Math.random().toString(36).substr(2,6);
    let d=[],l=[],i=0,T;

    // ======== 多语言包 ========
    const langMap = {
        zh: { action: '立即购买', price: '￥' },
        en: { action: 'Buy Now',   price: '$' },
        pl: { action: 'Kup teraz', price: 'zł' }
    };

    const getLang = () => {
        const lg = (c.lang || 'zh').toLowerCase();
        if (lg.startsWith('zh')) return 'zh';
        if (lg.startsWith('en')) return 'en';
        if (lg.startsWith('pl')) return 'pl';
        return 'zh';
    };

    const Lang = langMap[getLang()]; // 避免与函数 L 冲突

    // ======== Adblock 探测 ========
    function p(){
        const e=document.createElement('div');
        e.style.height='1px';
        e.style.position='absolute';
        e.className='z'+Math.random();
        document.body.appendChild(e);
        const h=getComputedStyle(e).display==='none';
        document.body.removeChild(e);
        return h;
    }

    // ======== 获取商品数据 ========
    async function f(){
        const k='u_d_v9',e=localStorage.getItem(k);
        if(e){
            const {d:t,t:s}=JSON.parse(e);
            if(Date.now()-s<6e5){
                // console.log('Using cached product data');
                return t; // 10分钟缓存
            }
        }
        try{
            const a=c.s+'/wp-json/wc/v3/products?consumer_key='+c.k+'&consumer_secret='+c.sc+'&per_page='+c.p+'&status=publish';
            console.log('Fetching products from:', a);
            const r=await fetch(a,{cache:'force-cache'});
            if(!r.ok)throw new Error('HTTP error ' + r.status);
            const j=await r.json();
            console.log('Fetched products:', j);
            const x=j.filter(p=>p.images.length>0).map(p=>({
                id:p.id,
                n:p.name,
                pr:p.price,
                img:p.images[0].src,
                lnk:p.permalink,
                c:p.categories.map(c=>c.name.toLowerCase()),
                des: (p.short_description || p.description || '').replace(/<[^>]*>/g, '').slice(0, 200) + '...',
                t:(p.name+p.description).toLowerCase()
            }));
            localStorage.setItem(k,JSON.stringify({d:x,t:Date.now()}));
            // 在控制台输出商品数据
            console.log('Processed products:', x);
            return x;
        }catch(e){
            console.error('Error fetching products:', e);
            return[];
        }
    }

    // ======== 提取关键词 ========
    function w(){
        const k=new Set();
        const meta=document.querySelector('meta[name="keywords"]');
        if(meta)meta.content.split(',').forEach(t=>k.add(t.trim().toLowerCase()));

        const h1=document.querySelector('h1,.entry-title');
        if(h1){
            const t=h1.textContent.trim().toLowerCase();
            t.split(/[\s,，。！？、\s]+/).filter(w=>w.length>1).forEach(w=>k.add(w));
        }

        const content = ['article .entry-content', 'article .entry', 'article .content', 'article', 'main', '.content', '.article', 'body'].reduce((r, s) => r || document.querySelector(s), null);
        if(content){
            const t=(content.textContent||'').slice(0,200).toLowerCase();
            const words=t.match(/[\u4e00-\u9fa5a-zA-Z0-9]{2,}/g)||[];
            words.slice(0,10).forEach(w=>k.add(w));
        }
        // console.log('Extracted keywords:', [...k]);
        return [...k];
    }

    // ======== 匹配商品 ========
    function M(d,k){
        if(!k.length)return d.slice(0,c.m);
        const result = d.map(p=>{
            let s=0;
            k.forEach(k=>{
                if(p.n.toLowerCase().includes(k))s+=3;
                if(p.t.includes(k))s+=1;
                if(p.c.includes(k))s+=2;
            });
            return {...p,s};
        }).filter(p=>p.s>=2).sort((a,b)=>b.s-a.s).slice(0,c.m);
        console.log('Matched products:', result);
        return result;
    }

    // ======== 宽高比 ========
    function P(){return innerWidth<=768?'56.25%':'25.77%'}

    // ======== 创建广告单元 ========
    function z(p){
        if (!p || !p.img) return {};

        const 
            m = /Mobi|Android|iPhone/i.test(navigator.userAgent),
            U = document.createElement('div'),
            B = document.createElement('div'),
            C = document.createElement('div');

        U.id = u;
        U.style.cssText = 'max-width:1200px;width:100%;margin:15px auto;overflow:hidden;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.15);position:relative;font:sans-serif';

        B.style.cssText = `position:relative;width:100%;height:0;padding-top:${P()}`;

        C.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;display:flex;background:#fff';
        C.innerHTML = `
            <div style="flex:1;min-width:100px;display:flex;align-items:center;justify-content:center;">
                <img src="${p.img}" alt="${p.n}" style="max-width:100%;max-height:100%;object-fit:contain">
            </div>
            <div style="flex:2;min-width:120px;padding:10px 15px;display:flex;flex-direction:column;justify-content:center;gap:6px">
                <div style="display:flex;flex-wrap:wrap;align-items:center;gap:8px;margin-bottom:4px">
                    <h3 style="margin:0;font:600 1rem sans-serif;color:#222;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0;"><strong><i style="margin:0;color:#d44000;white-space:nowrap;">${getLang() === 'pl' ? (+p.pr).toFixed(2).replace('.', ',') + ' ' + Lang.price : Lang.price + (+p.pr).toFixed(2)}&nbsp;&nbsp;</i></strong> ${p.n}</h3>
                </div>
                ${m ? '' : (p.des ? `<p style="margin:0;color:#666;font-size:.9rem">${p.des}</p>` : '')}
                <span class="u_d_btn" style="padding:10px 18px;background:#0077cc;color:#fff;border-radius:6px;font:bold .95em sans-serif;cursor:pointer;text-align:center">${Lang.action}</span>
            </div>
        `;
        B.appendChild(C);
        U.appendChild(B);

        // 关闭按钮
        const X = document.createElement('div');
        X.innerHTML = '×';
        X.style.cssText = 'position:absolute;top:10px;right:10px;width:26px;height:26px;background:#eee;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font:bold 20px Arial;cursor:pointer;z-index:1';
        X.onclick = e => { e.stopPropagation(); R('dismiss', p.id, p.n); U.remove(); };
        U.appendChild(X);

        // 🔐 安全绑定点击事件
        U.onclick = () => { R('click', p.id, p.n); open(p.lnk, '_blank'); };

        // ✅ 使用 class 定位按钮，避免 lastChild.lastChild 不可靠
        const btn = C.querySelector('.u_d_btn');
        if (btn) {
            btn.onclick = e => { e.stopPropagation(); R('click', p.id, p.n); open(p.lnk, '_blank'); };
        }

        return { U, B };
    }

    // ======== 上报事件 ========
    function R(t,id,n,f){
        console.log('Event reported:', t, id, n);
        if(c.g&&window.gtag)gtag('event','promo_'+t,{event_category:'Unit',event_label:n,value:1});
        if(c.up){
            const data={t,id,n,u:location.href,ts:Date.now(),lang:getLang()};
            navigator.sendBeacon?.(c.up,JSON.stringify(data))||fetch(c.up,{method:'POST',body:JSON.stringify(data),keepalive:!0}).catch(()=>{});
        }
        if(f)f();
    }

    // ======== 插入位置 ========
    function x(U){
        console.log('Inserting ad unit into page');
        const b = ['article .entry-content', 'article .entry', 'article .content', 'article', 'main', '.content', '.article', 'body'].reduce((r, s) => r || document.querySelector(s), null);
        if (!b) return;
        let r;
        switch(c.pos){
            case 'top': r = b.firstChild;break;
            case 'bottom': r = null;break;
            case 'after-first-p': r = b.querySelector('p')?.nextSibling || b.firstChild;break;
            case 'before-first-p': r = b.querySelector('p') || b.firstChild;break;
            default: r = b.querySelector('p:nth-of-type(2)')?.nextSibling || b.firstChild;
        }
        
        (c.pos === 'bottom' || !r || !b.contains(r)) ? b.appendChild(U) : b.insertBefore(U, r);
    }

    // ======== 轮播函数（S = Start Rotation）========
    function S(U,B){
        if(l.length<2){
            console.log('Less than 2 products, skipping rotation');
            return;
        }
        // console.log('Starting product rotation');
        T=setInterval(()=>{
            i=(i+1)%l.length;
            const{U:W,B:F}=z(l[i]);
            U.replaceWith(W);
            V(W,l[i]);
        },c.r);
    }

    // ======== 曝光监测 ========
    function V(U,p){
        // console.log('Setting up intersection observer for product:', p.n);
        new IntersectionObserver(e=>{
            if(e[0].isIntersecting){
                // console.log('Product is visible:', p.n);
                R('view',p.id,p.n);
            }
        },{threshold:0.5}).observe(U);
    }

    // ======== 主逻辑 ========
    async function run(){
        // console.log('Running Smart Unit main logic');
        d=await f();
        // console.log('Retrieved products:', d);
        if(!d.length){
            // console.log('No products found, exiting');
            return;
        }
        const k=w();
        // console.log('Keywords for matching:', k);
        l=M(d,k);
        // console.log('Matched products:', l);
        if(!l.length)l=[...d].sort(()=>.5-Math.random()).slice(0,c.m);
        if(!l.length){
            // console.log('Still no products after random selection, exiting');
            return;
        }
        const{U,B}=z(l[0]);
        x(U);
        S(U,B);  // 使用 S 而非 L
        V(U,l[0]);
        addEventListener('resize',()=>{clearTimeout(t);t=setTimeout(()=>B.style.paddingTop=P(),100)});
    }

    // ======== 延迟加载 ========
    const load=()=>{
        // console.log('Checking for adblock');
        const hasAdblock = p();
        // console.log('Adblock detected:', hasAdblock);
        if(hasAdblock){
            // console.log('Adblock detected, delaying execution by 1800ms');
            setTimeout(run,1800);
        } else {
            // console.log('No adblock detected, running immediately');
            run();
        }
    };
    
    // console.log('Setting up load callback');
    'requestIdleCallback' in window ? 
        requestIdleCallback(load, { timeout: 3000 }) : 
        setTimeout(load, 1200);

}();
