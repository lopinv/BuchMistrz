!function(){
    const t=document.currentScript;
    if(sessionStorage.u_s)return;

    // ======== 配置 ========
    const c={
        s:t?.getAttribute('data-s')||'https://www.buchmistrz.pl',
        k:t?.getAttribute('data-k')||'ck_xxxxxxxxxxxxxxxxxxxxxxxx',
        sc:t?.getAttribute('data-sc')||'cs_xxxxxxxxxxxxxxxxxxxxxxxx',
        p:t?.getAttribute('data-p')||20,
        r:t?.getAttribute('data-r')||8000,
        m:t?.getAttribute('data-m')||3,
        pos:t?.getAttribute('data-pos')||'after-first-p',
        lang:t?.getAttribute('data-lang')||document.documentElement.lang||navigator.language||'zh',
        o:!0,
        up:t?.getAttribute('data-up')||'',
        g:!!(t?.getAttribute('data-g')==='true')
    };

    if(c.o)sessionStorage.u_s=1;

    const u='u_'+Math.random().toString(36).substr(2,6);
    let d=[],l=[],i=0,T;

    // ======== 多语言包 ========
    const langMap = {
        zh: { action: '立即购买', price: '￥' },
        en: { action: 'Buy Now',   price: '$' },
        pl: { action: 'Kup teraz', price: 'zł' }
    };

    const getLang = () => {
        const lg = (c.lang || 'zh').toLowerCase();
        if (lg.startsWith('zh')) return 'zh';
        if (lg.startsWith('en')) return 'en';
        if (lg.startsWith('pl')) return 'pl';
        return 'zh';
    };

    const L = langMap[getLang()];

    // ======== Adblock 探测 ========
    function p(){
        const e=document.createElement('div');
        e.style.height='1px';
        e.style.position='absolute';
        e.className='z'+Math.random();
        document.body.appendChild(e);
        const h=getComputedStyle(e).display==='none';
        document.body.removeChild(e);
        return h;
    }

    // ======== 获取商品数据 ========
    async function f(){
        const k='u_d_v8',e=localStorage.getItem(k);
        if(e){
            const {d:t,t:s}=JSON.parse(e);
            if(Date.now()-s<6e5)return t; // 10分钟缓存
        }
        try{
            const a=c.s+'/wp-json/wc/v3/products?consumer_key='+c.k+'&consumer_secret='+c.sc+'&per_page='+c.p+'&status=publish';
            const r=await fetch(a,{cache:'force-cache'});
            if(!r.ok)throw 0;
            const j=await r.json();
            const x=j.filter(p=>p.images.length>0).map(p=>({
                id:p.id,
                n:p.name,
                pr:p.price,
                img:p.images[0].src,
                lnk:p.permalink,
                c:p.categories.map(c=>c.name.toLowerCase()),
                t:(p.name+p.description).toLowerCase()
            }));
            localStorage.setItem(k,JSON.stringify({d:x,t:Date.now()}));
            return x;
        }catch(e){return[]}
    }

    // ======== 提取关键词 ========
    function w(){
        const k=new Set();
        const meta=document.querySelector('meta[name="keywords"]');
        if(meta)meta.content.split(',').forEach(t=>k.add(t.trim().toLowerCase()));

        const h1=document.querySelector('h1,.entry-title');
        if(h1){
            const t=h1.textContent.trim().toLowerCase();
            t.split(/[\s,，。！？、\s]+/).filter(w=>w.length>1).forEach(w=>k.add(w));
        }

        const content=document.querySelector('.content,article,.post-body');
        if(content){
            const t=(content.textContent||'').slice(0,200).toLowerCase();
            const words=t.match(/[\u4e00-\u9fa5a-zA-Z0-9]{2,}/g)||[];
            words.slice(0,10).forEach(w=>k.add(w));
        }
        return [...k];
    }

    // ======== 匹配商品 ========
    function M(d,k){
        if(!k.length)return d.slice(0,c.m);
        return d.map(p=>{
            let s=0;
            k.forEach(k=>{
                if(p.n.toLowerCase().includes(k))s+=3;
                if(p.t.includes(k))s+=1;
                if(p.c.includes(k))s+=2;
            });
            return {...p,s};
        }).filter(p=>p.s>=2).sort((a,b)=>b.s-a.s).slice(0,c.m);
    }

    // ======== 宽高比 ========
    function P(){return innerWidth<=768?'56.25%':'25.77%'}

    // ======== 创建广告单元 ========
    function z(p){
        const U=document.createElement('div');
        U.id=u;
        U.style.cssText='max-width:1200px;margin:24px auto;border-radius:12px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,0.15);position:relative;font-family:sans-serif';

        const B=document.createElement('div');
        B.style.cssText=`position:relative;width:100%;height:0;padding-top:${P()}`;

        const C=document.createElement('div');
        C.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:'+((innerWidth<=768)?'column':'row')+';background:#fff';

        const I=document.createElement('div');
        I.style.flex=(innerWidth<=768)?'none;height:60%':'1';
        const img=document.createElement('img');
        img.src=p.img;
        img.alt=p.n;
        img.style.cssText='width:100%;height:100%;object-fit:cover';
        I.appendChild(img);

        const T=document.createElement('div');
        T.style.cssText='flex:1;padding:16px 20px;background:#f9f9f9;display:flex;flex-direction:column;justify-content:center;gap:6px';
        T.innerHTML=`
            <h3 style="margin:0;font:600 1rem sans-serif;color:#222;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.n}</h3>
            <p style="margin:0;color:#d44000"><strong>${L.price}${+p.pr}</strong></p>
            <span style="padding:10px 18px;background:#0077cc;color:#fff;border-radius:6px;text-align:center;font:bold 0.95em sans-serif;cursor:pointer">${L.action}</span>
        `;

        C.append(I,T);
        B.appendChild(C);
        U.appendChild(B);

        // 关闭按钮
        const X=document.createElement('div');
        X.innerHTML='&times;';
        X.style.cssText='position:absolute;top:10px;right:10px;width:26px;height:26px;background:rgba(0,0,0,0.7);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font:bold 20px Arial;cursor:pointer;z-index:1';
        X.onclick=e=>{e.stopPropagation();R('dismiss',p.id,p.n);U.remove();clearInterval(T)};
        U.appendChild(X);

        // 点击跳转
        U.style.cursor='pointer';
        U.onclick=R.bind(0,'click',p.id,p.n,(()=>window.open(p.lnk,'_blank')));
        T.lastChild.onclick=e=>{e.stopPropagation();R('click',p.id,p.n);window.open(p.lnk,'_blank')};

        return{U,B};
    }

    // ======== 上报事件 ========
    function R(t,id,n,f){
        if(c.g&&window.gtag)gtag('event','promo_'+t,{event_category:'Unit',event_label:n,value:1});
        if(c.up){
            const data={t,id,n,u:location.href,ts:Date.now(),lang:getLang()};
            navigator.sendBeacon?.(c.up,JSON.stringify(data))||fetch(c.up,{method:'POST',body:JSON.stringify(data),keepalive:!0}).catch(()=>{});
        }
        if(f)f();
    }

    // ======== 插入位置 ========
    function x(U){
        const b=document.body;
        let r;
        switch(c.pos){
            case'top':r=b.firstChild;break;
            case'bottom':r=null;break;
            default:r=(document.querySelector('p:nth-of-type(2),article p')||b.children[0])?.nextSibling;
        }
        b.insertBefore(U,r||null);
    }

    // ======== 轮播 ========
    function L(U,B){
        if(l.length<2)return;
        T=setInterval(()=>{
            i=(i+1)%l.length;
            const{U:W,B:F}=z(l[i]);
            U.replaceWith(W);
            V(W,l[i]);
        },c.r);
    }

    // ======== 曝光监测 ========
    function V(U,p){
        new IntersectionObserver(e=>{
            if(e[0].isIntersecting)R('view',p.id,p.n);
        },{threshold:0.5}).observe(U);
    }

    // ======== 主逻辑 ========
    async function run(){
        d=await f();
        if(!d.length)return;
        const k=w();
        l=M(d,k);
        if(!l.length)l=[...d].sort(()=>.5-Math.random()).slice(0,c.m);
        if(!l.length)return;
        const{U,B}=z(l[0]);
        x(U);
        L(U,B);
        V(U,l[0]);
        addEventListener('resize',()=>{clearTimeout(t);t=setTimeout(()=>B.style.paddingTop=P(),100)});
    }

    // ======== 延迟加载 ========
    const load=()=>(p()?setTimeout(run,1800):run());
    'requestIdleCallback' in window ? 
        requestIdleCallback(load, { timeout: 3000 }) : 
        setTimeout(load, 1200);

}();
